<html layout:decorate="~{layout}">
<main class="container" layout:fragment="content">
	<hr>
	<form name = "searchForm" class="input-group mt-3">
		<input type = "text" class = "form-control" id = "start_name">
		<span class = "input-group-text">▶</span>
		<input type = "text" class = "form-control" th:value = "${place.placename}">
	</form>
	<hr>
	<div class="map_wrap">
		<div id="map"></div>
	</div>
	<hr>

	<section class="place_info">
		<input type= "hidden" id = "place_x" th:value = "${place.longitude}">
		<input type= "hidden" id = "place_y" th:value = "${place.latitude}">
		<img th:if = "${place.ctgr==''}" src="/img/all.png" id = "dest_img">
		<img th:unless = "${place.ctgr==''}" th:src="@{${'/img/'+place.ctgr+'.png'}}" id = "dest_img">
		<div>
			<b th:text = "${place.placename}"></b>
			<br>
			<button class = "btn btn-sm btn-outline-custom">북마크</button>
			<a th:href = "@{|/review/list?id=${place.id}|}">리뷰</a>
			<p th:text = "${place.addr}"></p>
		</div>
	</section>
	<script defer src= "/js/map.js"></script>
	<script>
	let placeX = document.querySelector("#place_x");
	let placeY = document.querySelector("#place_y");
	let startName = document.querySelector("#start_name");
	
	function success(pos){
		currentPos = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
		let destPos = new kakao.maps.LatLng(Number(placeY.value), Number(placeX.value));
		drawMap(currentPos);
		
		let points = [
			currentPos,
			destPos
		];
		let bounds = new kakao.maps.LatLngBounds();
		let currentMarker = new kakao.maps.Marker({
			map:map,
		    position: currentPos,
		    image: markerImage
		});
		let destMarker = new kakao.maps.Marker({
	        map: map,
	        position: destPos
	    });
		
		bounds.extend(currentPos);
		bounds.extend(destPos);
		
		geocoder.coord2Address(currentPos.getLng(), currentPos.getLat(), function(result, status){
			if (status === kakao.maps.services.Status.OK) {
				let content = result[0].address.address_name;
				startName.value = content;
			}
		});
		
		let linepath =[];
		
		let origin = 'origin='+pos.coords.longitude+","+pos.coords.latitude;
		let dest = '&destination='+Number(placeX.value)+','+Number(placeY.value);
		fetch('https://apis-navi.kakaomobility.com/v1/directions?'+origin+
				dest+"&car_type=7&priority=distance&summary=false&avoid=motorway", {
	    	method: 'get',
	    	headers: {
	    		Authorization: 'KakaoAK 20e11ac823d1e1da60abf91d242a5478',
	            'content-type': 'application/json'
	        },
	    })
	    .then((response)=>response.json())
	    .then((data)=>{
	    	console.log(data);
	    	let temp = data.routes[0].sections[0].guides;
	    	temp.forEach((item)=>{
	    		let pathPos = new kakao.maps.LatLng(Number(item.y), Number(item.x));
	    		linepath.push(pathPos);
	    		bounds.extend(pathPos);
	    	})
	    	let polyline = new kakao.maps.Polyline({
				path:linepath,
				strokeWeight:3,
				strokeColor: '#75B8FA',
				strokeOpacity:1,
				strokeStyle:'solid'
			});
	    	map.setBounds(bounds);
			polyline.setMap(map);
	    });
	}

	</script>
</main>
</html>