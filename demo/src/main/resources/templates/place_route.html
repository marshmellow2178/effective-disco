<html layout:decorate="~{layout}">
<main class="container" layout:fragment="content">
	<hr>
	<form name = "searchForm" class="input-group mt-3">
		<div class = "input-group">
		<label class = "col-form-label mr-3">🔰 출발</label>
		<th:block th:if = "${start != null}">
			<input type = "hidden" id = "start_x" th:value = "${start.longitude}">
			<input type= "hidden" id = "start_y" th:value = "${start.latitude}">
			<input type = "text" class = "form-control col-3" th:value = "${start.placename}">
			<input type = "text" class = "form-control col-6 ml-3" th:value = "${start.addr}" disabled>
		</th:block>
		<th:block th:if = "${start == null}">
			<input type = "hidden" id = "start_x" value = "">
			<input type= "hidden" id = "start_y" value = "">
			<input type = "text" class = "form-control col-3" id = "start_name">
			<input type = "text" class = "form-control col-6 ml-3" id = "start_addr" disabled>
		</th:block>
		</div>
		<div class = "input-group mt-3">
		<label class = "col-form-label mr-3">🔍 검색</label>
		<input type = "text" class = "form-control col-3" th:value = "${place.placename}">
		<input type = "text" class = "form-control col-6 ml-3" th:value = "${place.addr}" disabled>
		</div>
	</form>
	<hr>
	<div class="map_wrap">
		<div id="map"></div>
	</div>
	<hr>

	<section class="place_info">
		<input type= "hidden" id = "place_x" th:value = "${place.longitude}">
		<input type= "hidden" id = "place_y" th:value = "${place.latitude}">
		<img th:if = "${place.ctgr==''}" src="/img/all.png" id = "dest_img">
		<img th:unless = "${place.ctgr==''}" th:src="@{${'/img/'+place.ctgr+'.png'}}" id = "dest_img">
		<div>
			<b th:text = "${place.placename}"></b>
			<div class = "my-1">
				<a class = "btn btn-sm btn-outline-custom" href = "javascript:history.back();">목록</a>
				<a class = "btn btn-sm btn-outline-custom" th:href = "@{|/review/list?id=${place.id}|}">리뷰</a>
			</div>
			<p th:text = "${place.addr}"></p>
		</div>
	</section>
	<script src= "/js/map.js"></script>
	<script>
	let startX = document.querySelector("#start_x");
	let startY = document.querySelector("#start_y");
	let placeX = document.querySelector("#place_x");
	let placeY = document.querySelector("#place_y");
	let startName = document.querySelector("#start_name");
	let startAddr = document.querySelector("#start_addr");
	
	navigator.geolocation.getCurrentPosition(success);
	
	function success(pos){
		let startLng;
		let startLat;
		if(startX.value != ''){
			startLng = Number(startX.value);
			startLat = Number(startY.value);
		}else{
			startLng = pos.coords.longitude;
			startLat = pos.coords.latitude;
			geocoder.coord2Address(startLng, startLat, function(result, status){
				if (status === kakao.maps.services.Status.OK) {
					let content = result[0].address.address_name;
					startAddr.value = content;
					startName.value = '현재 위치';
				}
			});
		}
		currentPos = new kakao.maps.LatLng(startLat, startLng);
		let destPos = new kakao.maps.LatLng(Number(placeY.value), Number(placeX.value));

		let options = {
			    center: currentPos,
			    draggable: false, //지도변경금지
			    level: 4
			};
		map = new kakao.maps.Map(container, options);
		
		
		let points = [
			currentPos,
			destPos
		];
		let bounds = new kakao.maps.LatLngBounds();
		let currentMarker = new kakao.maps.Marker({
			map:map,
		    position: currentPos,
		    image: markerImage
		});
		let destMarker = new kakao.maps.Marker({
	        map: map,
	        position: destPos
	    });
		
		bounds.extend(currentPos);
		bounds.extend(destPos);
		
		let linepath =[];
		
		let origin = 'origin='+startLng+","+startLat;
		let dest = '&destination='+Number(placeX.value)+','+Number(placeY.value);
		fetch('https://apis-navi.kakaomobility.com/v1/directions?'+origin+
				dest+"&car_type=7&priority=distance&summary=false&avoid=motorway", {
	    	method: 'get',
	    	headers: {
	    		Authorization: 'KakaoAK 20e11ac823d1e1da60abf91d242a5478',
	            'content-type': 'application/json'
	        },
	    })
	    .then((response)=>response.json())
	    .then((data)=>{
	    	let temp = data.routes[0].sections[0].guides;
	    	temp.forEach((item)=>{
	    		let pathPos = new kakao.maps.LatLng(Number(item.y), Number(item.x));
	    		linepath.push(pathPos);
	    		bounds.extend(pathPos);
	    	})
	    	let polyline = new kakao.maps.Polyline({
				path:linepath,
				strokeWeight:3,
				strokeColor: '#75B8FA',
				strokeOpacity:1,
				strokeStyle:'solid'
			});
	    	map.setBounds(bounds);
			polyline.setMap(map);
	    });
	}

	</script>
</main>
</html>